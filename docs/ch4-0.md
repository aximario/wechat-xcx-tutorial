# 制作列表

这一章主要会教大家如何用小程序制作一个可以无限加载的列表。希望大家能通过这个例子掌握制作各种列表的原理。

## 核心API

1. wx:for 的用法
2. onReachBottom 的用法
3. wx.storage 的用法
4. wx.request 的用法
5. Promise
6. onShareAppMessage的用法

## index.wxml

首先我们来构建列表页的 `wxml` 结构。通过分析设计稿可以看出，这个列表是按照每天的文章分循环，在每天的文章里又按照文章分循环。所以可以知道 `wxml` 的主体结构是循环套循环。所以我们可以初步写出下面的结构：

```html
<view wx:for="{{ articleList }}" wx:for-item="group" wx:key="{{ group.date }}">
	<view wx:for="{{ group }}" wx:for-item="item" wx:key="{{ item.contentId }}"></view>
</view>
```

这里有一点需要**注意**：在 `wxml` 做循环嵌套的时候，一定要重新定义 `wx:for-item` 字段。因为 `wxml` 循环中当前项的下标变量名默认为 `index`，当前项的变量名默认为 `item`。如果没有重新定义 `item`，在内层循环里通过 `item` 取到的值其实是外层循环的值。

> [列表渲染](https://mp.weixin.qq.com/debug/wxadoc/dev/framework/view/wxml/list.html)

接下来就看看具体的结构，首先，每一天都有一个日期做开头，然后下面是一天的 4 篇文章。每篇文章分为左右结构，左边是标题，最多 3 行，超过的文字就用 … 表示。右边是一张文章的封面图。上面的日期如果是今天就显示今天，否则就直接显示月日，所以可以把 `wxml` 结构丰富成下面的样子：

```html
<!--repeat-->
<view wx:for="{{ articleList }}" wx:for-item="group" wx:key="{{ group.date }}" class="group">
  <view class="group-bar">
  	<view class="group-title {{ group.formateDate === '今日' ? 'on' : ''}}">{{ group.formateDate }}</view>
  </view>
	<view wx:for="{{ group }}" wx:for-item="item" wx:key="{{ item.contentId }}">
  		<!--repeat-->
    	<view wx:for="{{ group.articles }}" wx:for-item="item" wx:key="{{ item.contentId }}" class="group-content-item">
          <view class="group-content-item-desc ellipsis-multi-line ellipsis-line-3">{{ item.title }}</view>
          <image mode="aspectFill" class="group-content-item-img" src="{{ item.cover || defaultImg.coverImg }}" ></image>
      </view>
  </view>
</view>
```

这里又一个图片处理的属性可以看看相应的 API 了解下

> [图片处理](https://mp.weixin.qq.com/debug/wxadoc/dev/component/image.html)

接下来我们我们分析下用户的交互，所有的文章都是可以点击的，所以我们需要给它们加上点击时间，然后，我们又一个需求是用户点过的文章，标题需要变灰。所以在点击事件里我们需要做点击记录。然后，在用户拉到列表的最底端，我们要加载更多的文章给用户，所以这件事情需要在 onReachBottom 里做掉。把这些交互考虑进去之后的 `wxml` 就是下面这样的：

```html
<view class="wrapper">
    <!--repeat-->
    <view wx:for="{{ articleList }}" wx:for-item="group" wx:key="{{ group.date }}" class="group">
        <view class="group-bar">
            <view class="group-title {{ group.formateDate === '今日' ? 'on' : ''}}">{{ group.formateDate }}</view>
        </view>
        <view class="group-content">
            <!--repeat-->
            <view wx:for="{{ group.articles }}" wx:for-item="item" wx:key="{{ item.contentId }}" data-item="{{ item }}" bindtap="showDetail" class="group-content-item {{ item.hasVisited ? 'visited' : '' }}">
                <view class="group-content-item-desc ellipsis-multi-line ellipsis-line-3">{{ item.title }}</view>
                <image mode="aspectFill" class="group-content-item-img" src="{{ item.cover || defaultImg.coverImg }}" ></image>
            </view>
        </view>
    </view>

    <view hidden="{{ hasMore }}" class="no-more">暂时没有更多内容</view>
</view>
```



## index.wxss

把样式加上就是这样的：

```css
.wrapper .group {
  padding: 0 36rpx 10rpx 36rpx;
  background: #fff;
  margin-bottom: 16rpx
}

.wrapper .group-bar {
  height: 114rpx;
  text-align: center
}

.wrapper .group-title {
  position: relative;
  display: inline-block;
  padding: 0 12rpx;
  height: 40rpx;
  line-height: 40rpx;
  border-radius: 4rpx;
  border: solid 1rpx #e0e0e2;
  font-size: 28rpx;
  color: #ccc;
  margin-top: 38rpx;
  overflow: visible
}

.wrapper .group-title:after,.wrapper .group-title:before {
  content: '';
  top: 18rpx;
  position: absolute;
  width: 32rpx;
  height: 1rpx;
  transform: scaleY(.5);
  border-bottom: solid 1px #efefef
}

.wrapper .group-title:before {
  left: -56rpx
}

.wrapper .group-title:after {
  right: -56rpx
}

.wrapper .group-title.on {
  border: solid 1rpx #ffc60e;
  color: #ffc60e
}

.wrapper .group-title.on:after,.wrapper .group-title.on:before {
  border-bottom: solid 1px #ffc60e
}

.wrapper .group-content-item {
  position: relative;
  width: 100%;
  height: 194rpx;
  margin-bottom: 28rpx
}

.wrapper .group-content-item-desc {
  font-size: 36rpx;
  font-weight: 500;
  height: 156rpx;
  line-height: 52rpx;
  margin-right: 300rpx;
  margin-top: 8rpx;
  overflow: hidden;
  color: #333
}

.wrapper .group-content-item-img {
  position: absolute;
  right: 0;
  top: 0;
  vertical-align: top;
  width: 260rpx;
  height: 194rpx
}

.wrapper .group-content-item.visited .group-content-item-desc {
  color: #999
}

.wrapper .no-more {
  height: 44rpx;
  line-height: 44rpx;
  font-size: 32rpx;
  color: #ccc;
  text-align: center;
  padding: 20rpx 0
}
```



## index.js

我们首先挖出和渲染相关的数据：

```js
data: {
  page: 1, //当前的页数
  days: 3,
  pageSize: 4,
  totalSize: 0,
  hasMore: true,
  articleList: [], // 文章列表
  defaultImg: config.defaultImg
},
```

然后要做的第一件事就是获取列表的数据，初始化数据的工作我们一般放在生命周期的 `onLoad()` 里：

```javascript
onLoad (options) {
  this.initLoading();
  this.requestArticle();
},
  
/*
 * 获取文章列表数据
 */
requestArticle () {
  util.request({
    url: 'list',
    mock: true,
    // url: `${config.apiHost}/v1/article/tag/list`,
    data: {
      tag:'微信热门',
      start: this.data.page || 1,
      days: this.data.days || 3,
      pageSize: this.data.pageSize,
      langs: config.appLang || 'en'
    }
  })
  .then(res => {
    if (res && res.status === 0 && res.data && res.data.length) {
      let articleData = res.data;
      //格式化原始数据
      let formatData = this.formatArticleData(articleData);
      this.renderArticle(formatData);
  } else if (this.data.page === 1 && res.data && res.data.length === 0) {
      util.alert();
      this.setData({
      	hasMore: false
      });
  } else if (this.data.page !== 1 && res.data && res.data.length === 0) {
      this.setData({
        hasMore: false
      });
  } else {
      util.alert('提示', res);
      this.setData({
        hasMore: false
      });
      return null;
    }
  });
},
renderArticle (data) {
  if (data && data.length) {
    let newList = this.data.articleList.concat(data);
    this.setData({
      articleList: newList
    });
    loading.hide();
  }
}
```

上面我们把 `wx.request` 重新包装成了 `Promise` 的形式，其实我们是请求的 mock 数据。但是接口请求到的数据绝大部分情况下都不会直接适用于 `UI` 展示，所以我们需要做一层数据转换，把接口数据转换成视图数据。

```javascript
    /*
     * 格式化文章列表数据
     */
    formatArticleData (data) {
        let formatData = undefined;
        if (data && data.length) {
            formatData = data.map((group) => {
                group.formateDate = this.dateConvert(group.date);
                if (group && group.articles) {
                    let formatArticleItems = group.articles.map((item) => {
                        item.hasVisited = this.isVisited(item.contentId);
                        return item;
                    }) || [];
                    group.articles = formatArticleItems;
                }
                return group
            })
        }
        return formatData;
    },
      /*
     * 将原始日期字符串格式化 '2017-06-12'
     * return '今日' / 08-21 / 2017-06-12
     */
    dateConvert (dateStr) {
        if (!dateStr) {
            return '';
        }
        let today = new Date(),
            todayYear = today.getFullYear(),
            todayMonth = ('0' + (today.getMonth() + 1)).slice(-2),
            todayDay = ('0' + today.getDate()).slice(-2);
        let convertStr = '';
        let originYear = +dateStr.slice(0,4);
        let todayFormat = `${todayYear}-${todayMonth}-${todayDay}`;
        if (dateStr === todayFormat) {
            convertStr = '今日';
        } else if (originYear < todayYear) {
            let splitStr = dateStr.split('-');
            convertStr = `${splitStr[0]}年${splitStr[1]}月${splitStr[2]}日`;
        } else {
            convertStr = dateStr.slice(5).replace('-', '月') + '日'
        }
        return convertStr;
    },
      /*
     * 判断文章是否访问过
     * @param contentId
     */
    isVisited (contentId) {
        let visitedArticles = app.globalData && app.globalData.visitedArticles || '';
        return visitedArticles.indexOf(`${contentId}`) > -1;
    },
```

然后，我们给这个页面加上一个分享功能：

```javascript
	/*
     * 分享
     */
    onShareAppMessage () {
        let title = config.defaultShareText || '';
        return {
            title: title,
            path: `/pages/index/index`,
            success: function(res) {
                // 转发成功
            },
            fail: function(res) {
                // 转发失败
            }
        }
    },
```

> [分享](https://mp.weixin.qq.com/debug/wxadoc/dev/api/share.html#onshareappmessage)

最终的 `index.js` 文件就是这样的：

```javascript
'use strict';

import util from '../../utils/index';
import config from '../../utils/config';
import Loading from '../component/loading/loading';

let app = getApp();
let isDEV = config.isDev;
let loading;

let handler = {
    data: {
        page: 1,
        days: 3,
        pageSize: 4,
        totalSize: 0,
        hasMore: true,
        articleList: [],
        defaultImg: config.defaultImg
    },

    onLoad (options) {
        this.initLoading();
        this.requestArticle();
    },

    /*
     * 分享
     */
    onShareAppMessage () {
        let title = config.defaultShareText || '';
        return {
            title: title,
            path: `/pages/index/index`,
            success: function(res) {
                // 转发成功
            },
            fail: function(res) {
                // 转发失败
            }
        }
    },

    /*
     * 初始化loading
     */
    initLoading() {
        loading = new Loading(false, 'listLoading', this);
        loading.init();
    },

    /*
     * 跳转详情页
     */
    showDetail (e) {
        let dataset = e.currentTarget.dataset;
        let item = dataset && dataset.item;
        let contentId = item.contentId || 0;

        //记录点击过的文章
        this.markRead(contentId);
        wx.navigateTo({
            url: `../detail/detail?contentId=${contentId}`
        });
    },

    /*
     * 上拉触底事件
     */
    onReachBottom () {
        if (this.data.hasMore) {
            let nextPage = this.data.page + 1;
            this.setData({
                page: nextPage
            });
            this.requestArticle();
        }
    },

    /*
     * 获取文章列表数据
     */
    requestArticle () {
        util.request({
            url: 'list',
            mock: true,
            // url: `${config.apiHost}/v1/article/tag/list`,
            data: {
                tag:'微信热门',
                start: this.data.page || 1,
                days: this.data.days || 3,
                pageSize: this.data.pageSize,
                langs: config.appLang || 'en'
            }
        })
        .then(res => {
            if (res && res.status === 0 && res.data && res.data.length) {
                let articleData = res.data;
                //格式化原始数据
                let formatData = this.formatArticleData(articleData);
                this.renderArticle(formatData);
            } else if (this.data.page === 1 && res.data && res.data.length === 0) {
                util.alert();
                this.setData({
                    hasMore: false
                });
            } else if (this.data.page !== 1 && res.data && res.data.length === 0) {
                this.setData({
                    hasMore: false
                });
            } else {
                util.alert('提示', res);
                this.setData({
                    hasMore: false
                });
                return null;
            }
        });
    },

    /*
     * 判断文章是否访问过
     * @param contentId
     */
    isVisited (contentId) {
        let visitedArticles = app.globalData && app.globalData.visitedArticles || '';
        return visitedArticles.indexOf(`${contentId}`) > -1;
    },

    resetArticles () {
        let old = this.data.articleList;
        let newArticles = this.formatArticleData(old);
        this.setData({
            articleList: newArticles
        });
    },

    markRead (contentId) {
        util.getStorageData('visited', (data)=> {
            let newStorage = data;
            if (data) {
                if (data.indexOf(contentId) === -1) {
                    newStorage = `${data},${contentId}`;
                }
            } else {
                newStorage = `${contentId}`;
            }

            if (data !== newStorage) {
                if (app.globalData) {
                    app.globalData.visitedArticles = newStorage;
                }
                util.setStorageData('visited', newStorage, ()=>{
                    this.resetArticles();
                });
            }
        });
    },

    /*
     * 格式化文章列表数据
     */
    formatArticleData (data) {
        let formatData = undefined;
        if (data && data.length) {
            formatData = data.map((group) => {
                group.formateDate = this.dateConvert(group.date);
                if (group && group.articles) {
                    let formatArticleItems = group.articles.map((item) => {
                        item.hasVisited = this.isVisited(item.contentId);
                        return item;
                    }) || [];
                    group.articles = formatArticleItems;
                }
                return group
            })
        }
        return formatData;
    },

    /*
     * 将原始日期字符串格式化 '2017-06-12'
     * return '今日' / 08-21 / 2017-06-12
     */
    dateConvert (dateStr) {
        if (!dateStr) {
            return '';
        }
        let today = new Date(),
            todayYear = today.getFullYear(),
            todayMonth = ('0' + (today.getMonth() + 1)).slice(-2),
            todayDay = ('0' + today.getDate()).slice(-2);
        let convertStr = '';
        let originYear = +dateStr.slice(0,4);
        let todayFormat = `${todayYear}-${todayMonth}-${todayDay}`;
        if (dateStr === todayFormat) {
            convertStr = '今日';
        } else if (originYear < todayYear) {
            let splitStr = dateStr.split('-');
            convertStr = `${splitStr[0]}年${splitStr[1]}月${splitStr[2]}日`;
        } else {
            convertStr = dateStr.slice(5).replace('-', '月') + '日'
        }
        return convertStr;
    },

    /*
     * 文章标题格式化
     * 超过24个中文长度则截取掉
     */
    titleConvert (targetStr) {

    },

    renderArticle (data) {
        if (data && data.length) {
            let newList = this.data.articleList.concat(data);
            this.setData({
                articleList: newList
            });
            loading.hide();
        }
    }
};

Page(handler);
```

